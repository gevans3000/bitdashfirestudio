npm warn Unknown env config "http-proxy". This will stop working in the next major version of npm.

> bitdash-firestudio@1.0.0 lint
> ESLINT_USE_FLAT_CONFIG=false eslint -c .eslintrc.json "src/**/*.{ts,tsx,js,jsx}"


/workspace/bitdashfirestudio/src/__tests__/autoTaskRunner.state.test.ts
   80:11  error  'spawnMock' is assigned a value but never used   @typescript-eslint/no-unused-vars
   81:11  error  'execMock' is assigned a value but never used    @typescript-eslint/no-unused-vars
  111:11  error  'atomicMock' is assigned a value but never used  @typescript-eslint/no-unused-vars
  112:11  error  'lockMock' is assigned a value but never used    @typescript-eslint/no-unused-vars
  114:11  error  'spawnMock' is assigned a value but never used   @typescript-eslint/no-unused-vars
  120:11  error  'execMock' is assigned a value but never used    @typescript-eslint/no-unused-vars

/workspace/bitdashfirestudio/src/__tests__/memory-check.test.ts
   46:11  error  'execMock' is assigned a value but never used  @typescript-eslint/no-unused-vars
   81:11  error  'execMock' is assigned a value but never used  @typescript-eslint/no-unused-vars
  115:11  error  'execMock' is assigned a value but never used  @typescript-eslint/no-unused-vars
  121:11  error  'errMock' is assigned a value but never used   @typescript-eslint/no-unused-vars
  122:11  error  'exitMock' is assigned a value but never used  @typescript-eslint/no-unused-vars
  155:11  error  'execMock' is assigned a value but never used  @typescript-eslint/no-unused-vars
  161:11  error  'errMock' is assigned a value but never used   @typescript-eslint/no-unused-vars
  162:11  error  'exitMock' is assigned a value but never used  @typescript-eslint/no-unused-vars
  188:11  error  'execMock' is assigned a value but never used  @typescript-eslint/no-unused-vars
  194:11  error  'errMock' is assigned a value but never used   @typescript-eslint/no-unused-vars
  195:11  error  'exitMock' is assigned a value but never used  @typescript-eslint/no-unused-vars
  221:11  error  'execMock' is assigned a value but never used  @typescript-eslint/no-unused-vars
  227:11  error  'errMock' is assigned a value but never used   @typescript-eslint/no-unused-vars
  228:11  error  'exitMock' is assigned a value but never used  @typescript-eslint/no-unused-vars
  258:11  error  'execMock' is assigned a value but never used  @typescript-eslint/no-unused-vars
  264:11  error  'errMock' is assigned a value but never used   @typescript-eslint/no-unused-vars
  265:11  error  'exitMock' is assigned a value but never used  @typescript-eslint/no-unused-vars
  296:11  error  'execMock' is assigned a value but never used  @typescript-eslint/no-unused-vars
  302:11  error  'errMock' is assigned a value but never used   @typescript-eslint/no-unused-vars
  303:11  error  'exitMock' is assigned a value but never used  @typescript-eslint/no-unused-vars
  334:11  error  'execMock' is assigned a value but never used  @typescript-eslint/no-unused-vars
  340:11  error  'errMock' is assigned a value but never used   @typescript-eslint/no-unused-vars
  341:11  error  'exitMock' is assigned a value but never used  @typescript-eslint/no-unused-vars

/workspace/bitdashfirestudio/src/app/api/economic-events/route.ts
  5:32  error  Unexpected any. Specify a different type  @typescript-eslint/no-explicit-any

/workspace/bitdashfirestudio/src/app/api/funding-schedule/route.ts
  5:32  error  Unexpected any. Specify a different type  @typescript-eslint/no-explicit-any

/workspace/bitdashfirestudio/src/app/api/higher-candles/route.ts
  9:19  error  Unexpected any. Specify a different type  @typescript-eslint/no-explicit-any
  9:36  error  Unexpected any. Specify a different type  @typescript-eslint/no-explicit-any

/workspace/bitdashfirestudio/src/app/api/open-interest/route.ts
  5:32  error  Unexpected any. Specify a different type  @typescript-eslint/no-explicit-any

/workspace/bitdashfirestudio/src/app/api/prev-day/route.ts
  19:36  error  Unexpected any. Specify a different type  @typescript-eslint/no-explicit-any

/workspace/bitdashfirestudio/src/app/page.tsx
   45:15  error  'ComputedIndicators' is defined but never used  @typescript-eslint/no-unused-vars
   46:15  error  'TradeSignal' is defined but never used         @typescript-eslint/no-unused-vars
   73:25  error  '_t' is assigned a value but never used         @typescript-eslint/no-unused-vars
   73:40  error  '_f' is assigned a value but never used         @typescript-eslint/no-unused-vars
   73:49  error  '_s1' is assigned a value but never used        @typescript-eslint/no-unused-vars
   73:59  error  '_s2' is assigned a value but never used        @typescript-eslint/no-unused-vars
   73:69  error  '_d' is assigned a value but never used         @typescript-eslint/no-unused-vars
   73:80  error  '_u' is assigned a value but never used         @typescript-eslint/no-unused-vars
  279:41  error  Unexpected any. Specify a different type        @typescript-eslint/no-explicit-any
  280:41  error  Unexpected any. Specify a different type        @typescript-eslint/no-explicit-any
  652:11  error  Unexpected any. Specify a different type        @typescript-eslint/no-explicit-any

/workspace/bitdashfirestudio/src/lib/agents/IndicatorEngine.ts
  3:29  error  'IndicatorSet' is defined but never used  @typescript-eslint/no-unused-vars

/workspace/bitdashfirestudio/src/lib/agents/TestingAgent.ts
  16:10  error  '_msg' is defined but never used  @typescript-eslint/no-unused-vars

/workspace/bitdashfirestudio/src/lib/agents/UIRenderer.ts
  4:10  error  '_msg' is defined but never used  @typescript-eslint/no-unused-vars

/workspace/bitdashfirestudio/src/lib/data/binanceCandles.ts
  20:34  error  Unexpected any. Specify a different type  @typescript-eslint/no-explicit-any

/workspace/bitdashfirestudio/src/lib/data/bybitOpenInterest.ts
  11:36  error  Unexpected any. Specify a different type  @typescript-eslint/no-explicit-any
  13:37  error  Unexpected any. Specify a different type  @typescript-eslint/no-explicit-any

/workspace/bitdashfirestudio/src/lib/data/coingecko.ts
  20:34  error  Unexpected any. Specify a different type  @typescript-eslint/no-explicit-any
  36:34  error  Unexpected any. Specify a different type  @typescript-eslint/no-explicit-any

/workspace/bitdashfirestudio/src/lib/data/economicEvents.ts
   1:23  error  'FetchImportance' is defined but never used  @typescript-eslint/no-unused-vars
  16:34  error  Unexpected any. Specify a different type     @typescript-eslint/no-explicit-any

/workspace/bitdashfirestudio/src/lib/data/fmp.ts
  18:12  error  Unexpected any. Specify a different type  @typescript-eslint/no-explicit-any
  34:36  error  Unexpected any. Specify a different type  @typescript-eslint/no-explicit-any
  47:14  error  Unexpected any. Specify a different type  @typescript-eslint/no-explicit-any
  65:14  error  Unexpected any. Specify a different type  @typescript-eslint/no-explicit-any

/workspace/bitdashfirestudio/src/lib/data/fundingSchedule.ts
  11:36  error  Unexpected any. Specify a different type  @typescript-eslint/no-explicit-any
  13:37  error  Unexpected any. Specify a different type  @typescript-eslint/no-explicit-any

/workspace/bitdashfirestudio/src/lib/fetchCache.ts
  10:9  error  Unexpected any. Specify a different type  @typescript-eslint/no-explicit-any

/workspace/bitdashfirestudio/src/lib/signals.ts
  38:9  error  'now' is assigned a value but never used  @typescript-eslint/no-unused-vars

/workspace/bitdashfirestudio/src/scripts/autoTaskRunner.ts
  34:10  error  Unexpected constant condition                    no-constant-condition
  44:88  error  Unexpected any. Specify a different type         @typescript-eslint/no-explicit-any
  63:5   error  Move function declaration to function body root  no-inner-declarations
  86:5   error  Move function declaration to function body root  no-inner-declarations

/workspace/bitdashfirestudio/src/types/agent.ts
  1:35  error  Unexpected any. Specify a different type  @typescript-eslint/no-explicit-any

✖ 69 problems (69 errors, 0 warnings)

npm warn Unknown env config "http-proxy". This will stop working in the next major version of npm.

> bitdash-firestudio@1.0.0 test
> jest

/bin/sh: 1: /bin/sh: 1: %cI: not found
%s: not found
FAIL src/__tests__/append-memory.concurrent.test.ts (5.619 s)
  ● append-memory concurrency › serializes concurrent snapshot writes

    thrown: "Exceeded timeout of 5000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      20 |
      21 | describe('append-memory concurrency', () => {
    > 22 |   it('serializes concurrent snapshot writes', async () => {
         |   ^
      23 |     const dir = fs.mkdtempSync(path.join(os.tmpdir(), 'append-'));
      24 |     const snap = path.join(dir, 'context.snapshot.md');
      25 |     const p1 = run(snap, 'A', '100');

      at src/__tests__/append-memory.concurrent.test.ts:22:3
      at Object.<anonymous> (src/__tests__/append-memory.concurrent.test.ts:21:1)

FAIL src/__tests__/autoTaskRunner.test.ts (5.746 s)
  ● autoTaskRunner memory writes › serializes concurrent invocations

    thrown: "Exceeded timeout of 5000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      28 |
      29 | describe('autoTaskRunner memory writes', () => {
    > 30 |   it('serializes concurrent invocations', async () => {
         |   ^
      31 |     const dir = fs.mkdtempSync(path.join(os.tmpdir(), 'autorun-'));
      32 |     const file = path.join(dir, 'mem.log');
      33 |     const p1 = run(file, 'A', '100');

      at src/__tests__/autoTaskRunner.test.ts:30:3
      at Object.<anonymous> (src/__tests__/autoTaskRunner.test.ts:29:1)

FAIL src/__tests__/autoTaskRunner.state.test.ts
  ● autoTaskRunner writes › uses locks and atomic writes for tasks and signals

    TypeError: Cannot redefine property: spawnSync
        at Function.defineProperty (<anonymous>)

      78 |     const lockMock = jest.spyOn(utils, 'withFileLock').mockImplementation((_, fn) => { fn(); });
      79 |
    > 80 |     const spawnMock = jest.spyOn(cp, 'spawnSync').mockReturnValue({ stdout: '', stderr: '', status: 0 } as any);
         |                            ^
      81 |     const execMock = jest.spyOn(cp, 'execSync').mockReturnValue(Buffer.from(''));
      82 |
      83 |     withFsMocks(map, () => {

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/autoTaskRunner.state.test.ts:80:28)

  ● autoTaskRunner writes › halts when memory check fails

    TypeError: Cannot redefine property: spawnSync
        at Function.defineProperty (<anonymous>)

      112 |     const lockMock = jest.spyOn(utils, 'withFileLock').mockImplementation((_, fn) => { fn(); });
      113 |
    > 114 |     const spawnMock = jest.spyOn(cp, 'spawnSync').mockImplementation((cmd: string) => {
          |                            ^
      115 |       if (cmd === 'ts-node scripts/memory-check.ts') {
      116 |         return { stdout: 'fail', stderr: '', status: 1 } as any;
      117 |       }

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/autoTaskRunner.state.test.ts:114:28)

FAIL src/__tests__/memory-utils.test.ts
  ● Console

    console.error
      Malformed memory line: abc123 just text

      223 |       };
      224 |     } else {
    > 225 |       console.error(`Malformed memory line: ${raw}`);
          |               ^
      226 |       entry = {
      227 |         entryType: 'commit',
      228 |         hash,

      at Object.parseMemoryLines (scripts/memory-utils.ts:225:15)
      at Object.<anonymous> (src/__tests__/memory-utils.test.ts:331:27)

    console.error
      Malformed memory line: abcd123 | test

      223 |       };
      224 |     } else {
    > 225 |       console.error(`Malformed memory line: ${raw}`);
          |               ^
      226 |       entry = {
      227 |         entryType: 'commit',
      228 |         hash,

      at Object.parseMemoryLines (scripts/memory-utils.ts:225:15)
      at Object.<anonymous> (src/__tests__/memory-utils.test.ts:347:27)

  ● update-log › appends new commit entries from git log

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      124 |
      125 |     const execMock = jest
    > 126 |       .spyOn(cp, "execSync")
          |        ^
      127 |       .mockImplementation((cmd: string) => {
      128 |         if (cmd.startsWith("git cat-file -e")) return Buffer.from("");
      129 |         if (cmd.startsWith("git log")) {

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-utils.test.ts:126:8)

  ● update-log › runs memory-check when --verify flag passed

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      156 |
      157 |     const execMock = jest
    > 158 |       .spyOn(cp, "execSync")
          |        ^
      159 |       .mockImplementation((cmd: string) => {
      160 |         if (cmd.startsWith("git cat-file -e")) return Buffer.from("");
      161 |         if (cmd.startsWith("git log")) {

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-utils.test.ts:158:8)

  ● update-log › deduplicates existing entries

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      188 |
      189 |     const execMock = jest
    > 190 |       .spyOn(cp, "execSync")
          |        ^
      191 |       .mockReturnValue(Buffer.from(""));
      192 |
      193 |     withFsMocks({ [memPath]: tmpMem }, () => {

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-utils.test.ts:190:8)

FAIL src/__tests__/memory-check.test.ts
  ● memory-check › passes for ordered log

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      45 |     );
      46 |     const execMock = jest
    > 47 |       .spyOn(cp, 'execSync')
         |        ^
      48 |       .mockImplementation((cmd: string) => {
      49 |         if (cmd.includes('git log -1 --pretty=%s')) return Buffer.from('test');
      50 |         return Buffer.from('');

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-check.test.ts:47:8)

  ● memory-check › allows commit after task with earlier timestamp

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      80 |     );
      81 |     const execMock = jest
    > 82 |       .spyOn(cp, 'execSync')
         |        ^
      83 |       .mockImplementation((cmd: string) => {
      84 |         if (cmd.includes('git log -1 --pretty=%s')) return Buffer.from('msg');
      85 |         return Buffer.from('');

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-check.test.ts:82:8)

  ● memory-check › fails for unordered log

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      114 |     );
      115 |     const execMock = jest
    > 116 |       .spyOn(cp, 'execSync')
          |        ^
      117 |       .mockImplementation((cmd: string) => {
      118 |         if (cmd.includes('git log -1 --pretty=%s')) return Buffer.from('test');
      119 |         return Buffer.from('');

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-check.test.ts:116:8)

  ● memory-check › fails for missing mem-id

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      154 |     );
      155 |     const execMock = jest
    > 156 |       .spyOn(cp, 'execSync')
          |        ^
      157 |       .mockImplementation((cmd: string) => {
      158 |         if (cmd.includes('git log -1 --pretty=%s')) return Buffer.from('test');
      159 |         return Buffer.from('');

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-check.test.ts:156:8)

  ● memory-check › fails for mismatched summary

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      187 |     );
      188 |     const execMock = jest
    > 189 |       .spyOn(cp, 'execSync')
          |        ^
      190 |       .mockImplementation((cmd: string) => {
      191 |         if (cmd.includes('git log -1 --pretty=%s')) return Buffer.from('correct');
      192 |         return Buffer.from('');

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-check.test.ts:189:8)

  ● memory-check › fails for invalid entry format

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      220 |     );
      221 |     const execMock = jest
    > 222 |       .spyOn(cp, 'execSync')
          |        ^
      223 |       .mockImplementation((cmd: string) => {
      224 |         if (cmd.includes('git log -1 --pretty=%s')) return Buffer.from('something');
      225 |         return Buffer.from('');

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-check.test.ts:222:8)

  ● memory-check › fails when commit hashes repeat

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      257 |     );
      258 |     const execMock = jest
    > 259 |       .spyOn(cp, 'execSync')
          |        ^
      260 |       .mockImplementation((cmd: string) => {
      261 |         if (cmd.includes('git log -1 --pretty=%s')) return Buffer.from('c');
      262 |         return Buffer.from('');

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-check.test.ts:259:8)

  ● memory-check › fails when tasks timestamps decrease

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      295 |     );
      296 |     const execMock = jest
    > 297 |       .spyOn(cp, 'execSync')
          |        ^
      298 |       .mockImplementation((cmd: string) => {
      299 |         if (cmd.includes('git log -1 --pretty=%s')) return Buffer.from('t');
      300 |         return Buffer.from('');

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-check.test.ts:297:8)

  ● memory-check › fails when commit timestamps decrease

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      333 |     );
      334 |     const execMock = jest
    > 335 |       .spyOn(cp, 'execSync')
          |        ^
      336 |       .mockImplementation((cmd: string) => {
      337 |         if (cmd.includes('git log -1 --pretty=%s')) return Buffer.from('m');
      338 |         return Buffer.from('');

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-check.test.ts:335:8)

FAIL src/__tests__/snapshot-rotate.test.ts
  ● Console

    console.log
      context.snapshot.md trimmed to last 2 entries

      at Object.<anonymous> (scripts/snapshot-rotate.ts:43:13)

    console.log
      [dry-run] Would backup to /workspace/bitdashfirestudio/logs/context.snapshot.2025-01-01T00:00:00.000Z.bak and trim context.snapshot.md to last 1 entries

      at Object.<anonymous> (scripts/snapshot-rotate.ts:35:13)

  ● snapshot-rotate › truncates context.snapshot.md and creates backup

    expect(received).toBe(expected) // Object.is equality

    - Expected  - 0
    + Received  + 1

      ### 2025-01-01 | mem-002
      b
      ### 2025-01-02 | mem-003
      c

    +

      114 |     const snapOut = fs.readFileSync(tmpSnap, 'utf8');
      115 |     const backupOut = fs.readFileSync(tmpBackup, 'utf8');
    > 116 |     expect(snapOut).toBe(
          |                     ^
      117 |       '### 2025-01-01 | mem-002\n' +
      118 |         'b\n' +
      119 |         '### 2025-01-02 | mem-003\n' +

      at Object.<anonymous> (src/__tests__/snapshot-rotate.test.ts:116:21)

FAIL src/__tests__/economic-events-api.test.ts
  ● economic events api › returns high impact events

    Cannot find module '@/lib/data/economicEvents' from 'src/app/api/economic-events/route.ts'

      1 | import { NextResponse } from 'next/server'
    > 2 | import { fetchHighImpactEvents } from '@/lib/data/economicEvents'
        | ^
      3 | import { CACHE_TTL } from '@/lib/constants'
      4 |
      5 | let cache: { ts: number; data: any } | null = null

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (src/app/api/economic-events/route.ts:2:1)
      at src/__tests__/economic-events-api.test.ts:13:13
      at Object.<anonymous> (src/__tests__/economic-events-api.test.ts:12:10)

FAIL src/__tests__/correlation.test.ts
  ● correlation › zero correlation when arrays differ

    expect(received).toBeCloseTo(expected)

    Expected: 0
    Received: NaN

    Expected precision:    2
    Expected difference: < 0.005
    Received difference:   NaN

       9 |   it('zero correlation when arrays differ', () => {
      10 |     const val = correlation([1, 1, 1], [2, 3, 4]);
    > 11 |     expect(val).toBeCloseTo(0);
         |                 ^
      12 |   });
      13 | });
      14 |

      at Object.<anonymous> (src/__tests__/correlation.test.ts:11:17)

FAIL src/__tests__/mem-list.test.ts
  ● mem-list › prints last n entries

    expect(jest.fn()).toHaveBeenNthCalledWith(n, ...expected)

    n: 1
    Expected: "b"

    Number of calls: 0

      36 |       process.argv = orig
      37 |     })
    > 38 |     expect(log).toHaveBeenNthCalledWith(1, 'b')
         |                 ^
      39 |     expect(log).toHaveBeenNthCalledWith(2, 'c')
      40 |     log.mockRestore()
      41 |     fs.rmSync(dir, { recursive: true, force: true })

      at Object.<anonymous> (src/__tests__/mem-list.test.ts:38:17)

FAIL src/__tests__/mem-sync.test.ts
  ● mem-sync › merges logs from branch

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      13 |     const otherLines = 'a1 | A | y | 2025-01-01T00:00:00Z\n'
      14 |     const exec = jest
    > 15 |       .spyOn(cp, 'execSync')
         |        ^
      16 |       .mockReturnValue(otherLines as any)
      17 |     const read = jest
      18 |       .spyOn(utils, 'readMemoryLines')

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/mem-sync.test.ts:15:8)

FAIL src/__tests__/memory-json.test.ts
  ● memory-json › writes memory.json using atomicWrite with lock

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "/workspace/bitdashfirestudio/memory.json", Any<Function>

    Number of calls: 0

      48 |       ) + '\n';
      49 |
    > 50 |     expect(lockMock).toHaveBeenCalledWith(outPath, expect.any(Function));
         |                      ^
      51 |     expect(atomicMock).toHaveBeenCalledWith(outPath, expected);
      52 |
      53 |     readMock.mockRestore();

      at Object.<anonymous> (src/__tests__/memory-json.test.ts:50:22)

FAIL src/__tests__/precommit.test.ts
  ● pre-commit hook › invokes npm run mem-check

    TypeError: Cannot redefine property: spawnSync
        at Function.defineProperty (<anonymous>)

      16 |   it('invokes npm run mem-check', () => {
      17 |     const spy = jest
    > 18 |       .spyOn(cp, 'spawnSync')
         |        ^
      19 |       .mockReturnValue({ status: 0 } as any);
      20 |     runHook();
      21 |     expect(spy).toHaveBeenCalled();

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/precommit.test.ts:18:8)

FAIL src/__tests__/memgrep.test.ts
  ● memgrep › prints matching lines with ids or hashes

    expect(received).toContain(expected) // indexOf

    Expected value: StringContaining "abc123:"
    Received array: ["abc123: abc123 | fix bug | file | 2025-01-01T00:00:00Z", "mem-001: minor fix details"]

    Looks like you wanted to test for object/array equality with the stricter `toContain` matcher. You probably need to use `toContainEqual` instead.

      53 |
      54 |     const outputs = logMock.mock.calls.map((c) => c[0]);
    > 55 |     expect(outputs).toContain(expect.stringContaining('abc123:'));
         |                     ^
      56 |     expect(outputs).toContain('mem-001: minor fix details');
      57 |     expect(outputs.some((o) => /def456/.test(o))).toBe(false);
      58 |     expect(outputs.some((o) => /mem-002/.test(o))).toBe(false);

      at Object.<anonymous> (src/__tests__/memgrep.test.ts:55:21)

  ● memgrep › prints nothing when no match found

    expect(jest.fn()).not.toHaveBeenCalled()

    Expected number of calls: 0
    Received number of calls: 2

    1: "abc123: abc123 | fix bug | file | 2025-01-01T00:00:00Z"
    2: "mem-001: minor fix details"

      77 |     });
      78 |
    > 79 |     expect(logMock).not.toHaveBeenCalled();
         |                         ^
      80 |
      81 |     logMock.mockRestore();
      82 |     fs.rmSync(dir, { recursive: true, force: true });

      at Object.<anonymous> (src/__tests__/memgrep.test.ts:79:25)

  ● memgrep › respects --since and --until range

    expect(received).toContain(expected) // indexOf

    Expected value: StringContaining "bbb222:"
    Received array: ["abc123: abc123 | fix bug | file | 2025-01-01T00:00:00Z", "mem-001: minor fix details", "bbb222: bbb222 | fix late | file | 2025-01-03T00:00:00Z"]

    Looks like you wanted to test for object/array equality with the stricter `toContain` matcher. You probably need to use `toContainEqual` instead.

      109 |
      110 |     const outputs = logMock.mock.calls.map((c) => c[0]);
    > 111 |     expect(outputs).toContain(expect.stringContaining('bbb222:'));
          |                     ^
      112 |     expect(outputs).toContain('mem-011: late note');
      113 |     expect(outputs.some((o) => /aaa111/.test(o))).toBe(false);
      114 |     expect(outputs.some((o) => /mem-010/.test(o))).toBe(false);

      at Object.<anonymous> (src/__tests__/memgrep.test.ts:111:21)

FAIL src/__tests__/mem-diff.test.ts
  ● mem-diff › prints hashes missing from memory.log

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

       9 |       .mockReturnValue(['abc123 | test | file | 2025-01-01']);
      10 |     const execMock = jest
    > 11 |       .spyOn(cp, 'execSync')
         |        ^
      12 |       .mockReturnValue(Buffer.from('def456\nabc123\n'));
      13 |     const logMock = jest.spyOn(console, 'log').mockImplementation(() => {});
      14 |

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/mem-diff.test.ts:11:8)

  ● mem-diff › prints success message when all hashes present

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      32 |       ]);
      33 |     const execMock = jest
    > 34 |       .spyOn(cp, 'execSync')
         |        ^
      35 |       .mockReturnValue(Buffer.from('def456\nabc123\n'));
      36 |     const logMock = jest.spyOn(console, 'log').mockImplementation(() => {});
      37 |

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/mem-diff.test.ts:34:8)

FAIL src/__tests__/memory-api.test.ts
  ● memory api route › returns parsed memory entries

    Cannot find module '@/lib/constants' from 'src/app/api/memory/route.ts'

       5 |   MemoryEntry,
       6 | } from '../../../../scripts/memory-utils'
    >  7 | import { CACHE_TTL } from '@/lib/constants'
         | ^
       8 |
       9 | let cache: { ts: number; data: MemoryEntry[] } | null = null
      10 | const TTL = parseInt(process.env.MEMORY_API_TTL || String(CACHE_TTL / 1000), 10) * 1000

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (src/app/api/memory/route.ts:7:1)
      at src/__tests__/memory-api.test.ts:18:13
      at Object.<anonymous> (src/__tests__/memory-api.test.ts:17:10)

  ● memory api route › returns empty array when file missing

    Cannot find module '@/lib/constants' from 'src/app/api/memory/route.ts'

       5 |   MemoryEntry,
       6 | } from '../../../../scripts/memory-utils'
    >  7 | import { CACHE_TTL } from '@/lib/constants'
         | ^
       8 |
       9 | let cache: { ts: number; data: MemoryEntry[] } | null = null
      10 | const TTL = parseInt(process.env.MEMORY_API_TTL || String(CACHE_TTL / 1000), 10) * 1000

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (src/app/api/memory/route.ts:7:1)
      at src/__tests__/memory-api.test.ts:33:13
      at Object.<anonymous> (src/__tests__/memory-api.test.ts:32:10)

  ● memory api route › caches results using TTL

    Cannot find module '@/lib/constants' from 'src/app/api/memory/route.ts'

       5 |   MemoryEntry,
       6 | } from '../../../../scripts/memory-utils'
    >  7 | import { CACHE_TTL } from '@/lib/constants'
         | ^
       8 |
       9 | let cache: { ts: number; data: MemoryEntry[] } | null = null
      10 | const TTL = parseInt(process.env.MEMORY_API_TTL || String(CACHE_TTL / 1000), 10) * 1000

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (src/app/api/memory/route.ts:7:1)
      at src/__tests__/memory-api.test.ts:54:13
      at Object.<anonymous> (src/__tests__/memory-api.test.ts:53:10)

hint: Using 'master' as the name for the initial branch. This default branch name
hint: is subject to change. To configure the initial branch name to use in all
hint: of your new repositories, which will suppress this warning, call:
hint: 
hint: 	git config --global init.defaultBranch <name>
hint: 
hint: Names commonly chosen instead of 'master' are 'main', 'trunk' and
hint: 'development'. The just-created branch can be renamed via this command:
hint: 
hint: 	git branch -m <name>
hint: Using 'master' as the name for the initial branch. This default branch name
hint: is subject to change. To configure the initial branch name to use in all
hint: of your new repositories, which will suppress this warning, call:
hint: 
hint: 	git config --global init.defaultBranch <name>
hint: 
hint: Names commonly chosen instead of 'master' are 'main', 'trunk' and
hint: 'development'. The just-created branch can be renamed via this command:
hint: 
hint: 	git branch -m <name>
FAIL src/__tests__/mem-locate.test.ts
  ● mem-locate › prints block for commit hash

    expect(received).toContain(expected) // indexOf

    Expected substring: "mem-001"
    Received string:    ""

      56 |
      57 |     const out = logMock.mock.calls.map((c) => c[0]).join('\n');
    > 58 |     expect(out).toContain('mem-001');
         |                 ^
      59 |     expect(out).toContain('Commit SHA: abc123');
      60 |
      61 |     logMock.mockRestore();

      at Object.<anonymous> (src/__tests__/mem-locate.test.ts:58:17)

  ● mem-locate › prints block for mem-id

    expect(received).toContain(expected) // indexOf

    Expected substring: "mem-002"
    Received string:    ""

      81 |
      82 |     const out = logMock.mock.calls.map((c) => c[0]).join('\n');
    > 83 |     expect(out).toContain('mem-002');
         |                 ^
      84 |     expect(out).toContain('Commit SHA: def456');
      85 |
      86 |     logMock.mockRestore();

      at Object.<anonymous> (src/__tests__/mem-locate.test.ts:83:17)

FAIL src/__tests__/rebuild-memory.test.ts
  ● rebuild-memory › writes commit history to memory.log

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      18 |
      19 |     const origExec = cp.execSync;
    > 20 |     const execMock = jest.spyOn(cp, 'execSync').mockImplementation((cmd: string, opts?: any) => {
         |                           ^
      21 |       if (cmd.startsWith('ts-node') && cmd.includes('append-memory.ts')) {
      22 |         return Buffer.from('');
      23 |       }

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/rebuild-memory.test.ts:20:27)

  ● rebuild-memory › writes sequential mem-ids to snapshot

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      53 |     let count = 0;
      54 |     const execMock = jest
    > 55 |       .spyOn(cp, 'execSync')
         |        ^
      56 |       .mockImplementation((cmd: string, opts?: any) => {
      57 |         if (cmd.startsWith('ts-node') && cmd.includes('append-memory.ts')) {
      58 |           const sha = origExec('git rev-parse --short HEAD', {

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/rebuild-memory.test.ts:55:8)

FAIL src/__tests__/mem-rotate.test.ts
  ● mem-rotate › truncates memory.log and backs up previous log

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      93 |     fs.writeFileSync(tmpMem, "1\n2\n3\n4\n5\n6\n");
      94 |
    > 95 |     const execMock = jest.spyOn(cp, "execSync").mockReturnValue(Buffer.from(""));
         |                           ^
      96 |
      97 |     const map = {
      98 |       [memPath]: tmpMem,

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/mem-rotate.test.ts:95:27)

  ● mem-rotate › does not modify files during dry run

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      125 |     fs.writeFileSync(tmpMem, "1\n2\n3\n");
      126 |
    > 127 |     const execMock = jest.spyOn(cp, "execSync");
          |                           ^
      128 |
      129 |     const map = {
      130 |       [memPath]: tmpMem,

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/mem-rotate.test.ts:127:27)

PASS src/__tests__/codex-context.test.ts
FAIL src/__tests__/update-memory.test.ts
  ● update-memory › updates memory log, snapshot and rotates

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      72 |
      73 |     const calls: string[] = [];
    > 74 |     const execMock = jest.spyOn(cp, 'execSync').mockImplementation((cmd: string) => {
         |                           ^
      75 |       calls.push(cmd);
      76 |       if (cmd.includes('git log -1 --pretty=%s')) return Buffer.from('Task 1: summary');
      77 |       if (cmd.startsWith('grep -m 1')) return Buffer.from('next');

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/update-memory.test.ts:74:27)

PASS src/__tests__/cache.test.ts
PASS src/__tests__/sessions.test.ts
PASS src/__tests__/clean-locks.test.ts
PASS src/__tests__/indicators.test.ts
PASS src/__tests__/mem-status.test.ts
TypeError: Unknown file extension ".ts" for /workspace/bitdashfirestudio/scripts/append-memory.ts
    at Object.getFileProtocolModuleFormat [as file:] (node:internal/modules/esm/get_format:189:9)
    at defaultGetFormat (node:internal/modules/esm/get_format:232:36)
    at defaultLoad (node:internal/modules/esm/load:145:22)
    at async ModuleLoader.loadAndTranslate (node:internal/modules/esm/loader:477:45)
    at async ModuleJob._link (node:internal/modules/esm/module_job:110:19) {
  code: 'ERR_UNKNOWN_FILE_EXTENSION'
}
FAIL src/__tests__/memory-cli.test.ts (10.587 s)
  ● Console

    console.log
      memory.json written to /workspace/bitdashfirestudio/memory.json

      at memoryJson (scripts/memory-cli.ts:292:11)

    console.log
      memory.log updated

      at updateLog (scripts/memory-cli.ts:267:11)

    console.log
      cac65a6 | Task 106: finalize task removal (#288) | AGENTS.md, TASKS.md | 2025-06-10T15:10:55-04:00

      at memList (scripts/memory-cli.ts:169:34)

    console.log
      fb1ac6e | Task 111: remove obsolete docs (#289) | TASKS.md, TASKS2.md, app.md, app2.md, bitdash-setup.txt, docs/blueprint.md, memorymaker.md, newtasks.md, updates.md | 2025-06-10T16:25:05-04:00

      at memList (scripts/memory-cli.ts:169:34)

    console.log
      65461e2 | feat: Task 112: consolidate memory CLI (#290) | TASKS.md, scripts/mem-diff.ts, scripts/mem-rotate.ts, scripts/mem-status.ts, scripts/memgrep.ts, scripts/memory-cli.ts, src/__tests__/mem-diff.test.ts, src/__tests__/mem-rotate.test.ts, src/__tests__/mem-status.test.ts, src/__tests__/memgrep.test.ts, src/__tests__/memory-cli.test.ts | 2025-06-10T16:56:47-04:00

      at memList (scripts/memory-cli.ts:169:34)

    console.log
      a3fa01c | Task 99: cache dev deps via dev-deps script (#291) | TASKS.md, src/scripts/autoTaskRunner.ts | 2025-06-10T17:03:57-04:00

      at memList (scripts/memory-cli.ts:169:34)

    console.log
      5831e32 | Task 107: refactor update-memory to use memory-cli (#292) | scripts/update-memory.ts, src/__tests__/update-memory.test.ts | 2025-06-10T17:12:52-04:00

      at memList (scripts/memory-cli.ts:169:34)

    console.log
      c60d158 | Task 111: update docs for unified memory cli (#293) | .github/workflows/ci.yml, .github/workflows/mem-maintenance.yml, .github/workflows/pr-memory-status.yml, .husky/pre-commit, README.md, docs/SETUP_QUICKSTART.md | 2025-06-10T17:24:26-04:00

      at memList (scripts/memory-cli.ts:169:34)

    console.log
      339b35a | feat: Task 113: organize archive and restore utilities (#294) | README.md, TASKS.md, docs/SETUP_QUICKSTART.md, logs/block-113.txt, package.json, scripts/memory-cli.ts, scripts/memory/archive.ts, scripts/memory/restore.ts | 2025-06-11T07:59:50-04:00

      at memList (scripts/memory-cli.ts:169:34)

    console.log
      b0cbf14 | feat: Task 110: log mem-update errors (#295) | .husky/post-commit, scripts/memory-cli.ts | 2025-06-11T08:20:12-04:00

      at memList (scripts/memory-cli.ts:169:34)

    console.log
      2ebcb3d | feat: Task 112: remove legacy memory wrappers (#296) | logs/block-112-lint.txt, logs/block-112-test.txt, scripts/mem-diff.ts, scripts/mem-list.ts, scripts/mem-locate.ts, scripts/mem-rotate.ts, scripts/mem-status.ts, scripts/mem-sync.ts, scripts/memgrep.ts, src/__tests__/mem-list.test.ts, src/__tests__/mem-locate.test.ts, src/__tests__/mem-sync.test.ts | 2025-06-11T08:28:31-04:00

      at memList (scripts/memory-cli.ts:169:34)

    console.log
      befad85 | feat: Task 114: remove deprecated memory update scripts (#297) | TASKS.md, scripts/update-memory-log.ts, scripts/update-snapshot.ts, src/__tests__/memory-cli.test.ts, src/__tests__/memory-utils.test.ts, src/__tests__/update-snapshot.test.ts | 2025-06-11T08:48:26-04:00

      at memList (scripts/memory-cli.ts:169:34)

  ● memory-cli › runs mem-diff for diff command

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      23 |     const diffSpy = jest.spyOn(cli, 'memDiff').mockImplementation(() => {});
      24 |     run(['diff']);
    > 25 |     expect(diffSpy).toHaveBeenCalled();
         |                     ^
      26 |     spy.mockRestore();
      27 |   });
      28 |

      at Object.<anonymous> (src/__tests__/memory-cli.test.ts:25:21)

  ● memory-cli › runs memory-json for json command

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      30 |     const jsonSpy = jest.spyOn(cli, 'memoryJson').mockImplementation(() => {});
      31 |     run(['json']);
    > 32 |     expect(jsonSpy).toHaveBeenCalled();
         |                     ^
      33 |   });
      34 |
      35 |   it('runs clean-locks for clean-locks command', () => {

      at Object.<anonymous> (src/__tests__/memory-cli.test.ts:32:21)

  ● memory-cli › runs clean-locks for clean-locks command

    Property `cleanLocks` does not exist in the provided object

      34 |
      35 |   it('runs clean-locks for clean-locks command', () => {
    > 36 |     const clSpy = jest.spyOn(cli, 'cleanLocks').mockImplementation(() => {});
         |                        ^
      37 |     run(['clean-locks']);
      38 |     expect(clSpy).toHaveBeenCalled();
      39 |   });

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:731:13)
      at Object.<anonymous> (src/__tests__/memory-cli.test.ts:36:24)

  ● memory-cli › runs rebuild-memory for rebuild command

    Command failed: git log --reverse --pretty=format:%h|%s|%cI --name-only
    /bin/sh: 1: /bin/sh: 1: %cI: not found
    %s: not found

      312 |   if (fs.existsSync(memFile)) fs.unlinkSync(memFile);
      313 |   if (fs.existsSync(snapFile)) fs.unlinkSync(snapFile);
    > 314 |   const raw = execSync('git log --reverse --pretty=format:%h|%s|%cI --name-only', { cwd: repo, encoding: 'utf8' });
          |                       ^
      315 |   const lines = raw.trim().split('\n');
      316 |   const entries: { h: string; s: string; d: string; f: string[] }[] = [];
      317 |   let cur: { h: string; s: string; d: string; f: string[] } | undefined;

      at rebuildMemory (scripts/memory-cli.ts:314:23)
      at Object.handler (scripts/memory-cli.ts:393:129)
      at node_modules/yargs/build/index.cjs:1:9095
      at j (node_modules/yargs/build/index.cjs:1:5058)
      at _.handleValidationAndGetResult (node_modules/yargs/build/index.cjs:1:9064)
      at _.applyMiddlewareAndGetResult (node_modules/yargs/build/index.cjs:1:9706)
      at _.runCommand (node_modules/yargs/build/index.cjs:1:7333)
      at te.[runYargsParserAndExecuteCommands] (node_modules/yargs/build/index.cjs:1:58641)
      at te.parse (node_modules/yargs/build/index.cjs:1:40580)
      at Object.main (scripts/memory-cli.ts:399:6)
      at src/__tests__/memory-cli.test.ts:13:9
      at run (src/__tests__/memory-cli.test.ts:12:8)
      at Object.<anonymous> (src/__tests__/memory-cli.test.ts:48:5)

  ● memory-cli › runs update-log for update-log command

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      53 |     const updSpy = jest.spyOn(cli, 'updateLog').mockImplementation(() => {});
      54 |     run(['update-log']);
    > 55 |     expect(updSpy).toHaveBeenCalled();
         |                    ^
      56 |   });
      57 |
      58 |   it('runs update-snapshot for snapshot-update command', () => {

      at Object.<anonymous> (src/__tests__/memory-cli.test.ts:55:20)

  ● memory-cli › runs update-snapshot for snapshot-update command

    Command failed: ts-node scripts/append-memory.ts "feat: Task 114: remove deprecated memory update scripts (#297)" "none"

      357 |   const summary = lastCommitSummary();
      358 |   const nextTask = nextOpenTask();
    > 359 |   execSync(`ts-node scripts/append-memory.ts ${JSON.stringify(summary)} ${JSON.stringify(nextTask)}`, { cwd: repoRoot, stdio: 'inherit', shell: '/bin/bash' });
          |           ^
      360 | }
      361 |
      362 | export function main(argv = hideBin(process.argv)): void {

      at snapshotUpdate (scripts/memory-cli.ts:359:11)
      at Object.handler (scripts/memory-cli.ts:395:91)
      at node_modules/yargs/build/index.cjs:1:9095
      at j (node_modules/yargs/build/index.cjs:1:5058)
      at _.handleValidationAndGetResult (node_modules/yargs/build/index.cjs:1:9064)
      at _.applyMiddlewareAndGetResult (node_modules/yargs/build/index.cjs:1:9706)
      at _.runCommand (node_modules/yargs/build/index.cjs:1:7333)
      at te.[runYargsParserAndExecuteCommands] (node_modules/yargs/build/index.cjs:1:58641)
      at te.parse (node_modules/yargs/build/index.cjs:1:40580)
      at Object.main (scripts/memory-cli.ts:399:6)
      at src/__tests__/memory-cli.test.ts:13:9
      at run (src/__tests__/memory-cli.test.ts:12:8)
      at Object.<anonymous> (src/__tests__/memory-cli.test.ts:60:5)

  ● memory-cli › runs mem-list for list command

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      65 |     const listSpy = jest.spyOn(cli, 'memList').mockImplementation(() => {});
      66 |     run(['list']);
    > 67 |     expect(listSpy).toHaveBeenCalled();
         |                     ^
      68 |   });
      69 | });
      70 |

      at Object.<anonymous> (src/__tests__/memory-cli.test.ts:67:21)

FAIL src/__tests__/file-lock.test.ts (10.853 s)
  ● withFileLock › serializes concurrent writes

    thrown: "Exceeded timeout of 5000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      28 |
      29 | describe('withFileLock', () => {
    > 30 |   it('serializes concurrent writes', async () => {
         |   ^
      31 |     const dir = fs.mkdtempSync(path.join(os.tmpdir(), 'locktest-'));
      32 |     const file = path.join(dir, 'mem.txt');
      33 |     const p1 = run(file, 'A', '100');

      at src/__tests__/file-lock.test.ts:30:3
      at Object.<anonymous> (src/__tests__/file-lock.test.ts:29:1)

  ● withFileLock › handles many concurrent writers

    thrown: "Exceeded timeout of 5000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      87 |   });
      88 |
    > 89 |   it('handles many concurrent writers', async () => {
         |   ^
      90 |     const dir = fs.mkdtempSync(path.join(os.tmpdir(), 'locktest-'));
      91 |     const file = path.join(dir, 'mem.txt');
      92 |     const p1 = run(file, 'A', '200');

      at src/__tests__/file-lock.test.ts:89:3
      at Object.<anonymous> (src/__tests__/file-lock.test.ts:29:1)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
Summary of all failing tests
FAIL src/__tests__/append-memory.concurrent.test.ts (5.619 s)
  ● append-memory concurrency › serializes concurrent snapshot writes

    thrown: "Exceeded timeout of 5000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      20 |
      21 | describe('append-memory concurrency', () => {
    > 22 |   it('serializes concurrent snapshot writes', async () => {
         |   ^
      23 |     const dir = fs.mkdtempSync(path.join(os.tmpdir(), 'append-'));
      24 |     const snap = path.join(dir, 'context.snapshot.md');
      25 |     const p1 = run(snap, 'A', '100');

      at src/__tests__/append-memory.concurrent.test.ts:22:3
      at Object.<anonymous> (src/__tests__/append-memory.concurrent.test.ts:21:1)

FAIL src/__tests__/autoTaskRunner.test.ts (5.746 s)
  ● autoTaskRunner memory writes › serializes concurrent invocations

    thrown: "Exceeded timeout of 5000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      28 |
      29 | describe('autoTaskRunner memory writes', () => {
    > 30 |   it('serializes concurrent invocations', async () => {
         |   ^
      31 |     const dir = fs.mkdtempSync(path.join(os.tmpdir(), 'autorun-'));
      32 |     const file = path.join(dir, 'mem.log');
      33 |     const p1 = run(file, 'A', '100');

      at src/__tests__/autoTaskRunner.test.ts:30:3
      at Object.<anonymous> (src/__tests__/autoTaskRunner.test.ts:29:1)

FAIL src/__tests__/autoTaskRunner.state.test.ts
  ● autoTaskRunner writes › uses locks and atomic writes for tasks and signals

    TypeError: Cannot redefine property: spawnSync
        at Function.defineProperty (<anonymous>)

      78 |     const lockMock = jest.spyOn(utils, 'withFileLock').mockImplementation((_, fn) => { fn(); });
      79 |
    > 80 |     const spawnMock = jest.spyOn(cp, 'spawnSync').mockReturnValue({ stdout: '', stderr: '', status: 0 } as any);
         |                            ^
      81 |     const execMock = jest.spyOn(cp, 'execSync').mockReturnValue(Buffer.from(''));
      82 |
      83 |     withFsMocks(map, () => {

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/autoTaskRunner.state.test.ts:80:28)

  ● autoTaskRunner writes › halts when memory check fails

    TypeError: Cannot redefine property: spawnSync
        at Function.defineProperty (<anonymous>)

      112 |     const lockMock = jest.spyOn(utils, 'withFileLock').mockImplementation((_, fn) => { fn(); });
      113 |
    > 114 |     const spawnMock = jest.spyOn(cp, 'spawnSync').mockImplementation((cmd: string) => {
          |                            ^
      115 |       if (cmd === 'ts-node scripts/memory-check.ts') {
      116 |         return { stdout: 'fail', stderr: '', status: 1 } as any;
      117 |       }

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/autoTaskRunner.state.test.ts:114:28)

FAIL src/__tests__/memory-utils.test.ts
  ● update-log › appends new commit entries from git log

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      124 |
      125 |     const execMock = jest
    > 126 |       .spyOn(cp, "execSync")
          |        ^
      127 |       .mockImplementation((cmd: string) => {
      128 |         if (cmd.startsWith("git cat-file -e")) return Buffer.from("");
      129 |         if (cmd.startsWith("git log")) {

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-utils.test.ts:126:8)

  ● update-log › runs memory-check when --verify flag passed

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      156 |
      157 |     const execMock = jest
    > 158 |       .spyOn(cp, "execSync")
          |        ^
      159 |       .mockImplementation((cmd: string) => {
      160 |         if (cmd.startsWith("git cat-file -e")) return Buffer.from("");
      161 |         if (cmd.startsWith("git log")) {

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-utils.test.ts:158:8)

  ● update-log › deduplicates existing entries

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      188 |
      189 |     const execMock = jest
    > 190 |       .spyOn(cp, "execSync")
          |        ^
      191 |       .mockReturnValue(Buffer.from(""));
      192 |
      193 |     withFsMocks({ [memPath]: tmpMem }, () => {

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-utils.test.ts:190:8)

FAIL src/__tests__/memory-check.test.ts
  ● memory-check › passes for ordered log

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      45 |     );
      46 |     const execMock = jest
    > 47 |       .spyOn(cp, 'execSync')
         |        ^
      48 |       .mockImplementation((cmd: string) => {
      49 |         if (cmd.includes('git log -1 --pretty=%s')) return Buffer.from('test');
      50 |         return Buffer.from('');

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-check.test.ts:47:8)

  ● memory-check › allows commit after task with earlier timestamp

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      80 |     );
      81 |     const execMock = jest
    > 82 |       .spyOn(cp, 'execSync')
         |        ^
      83 |       .mockImplementation((cmd: string) => {
      84 |         if (cmd.includes('git log -1 --pretty=%s')) return Buffer.from('msg');
      85 |         return Buffer.from('');

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-check.test.ts:82:8)

  ● memory-check › fails for unordered log

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      114 |     );
      115 |     const execMock = jest
    > 116 |       .spyOn(cp, 'execSync')
          |        ^
      117 |       .mockImplementation((cmd: string) => {
      118 |         if (cmd.includes('git log -1 --pretty=%s')) return Buffer.from('test');
      119 |         return Buffer.from('');

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-check.test.ts:116:8)

  ● memory-check › fails for missing mem-id

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      154 |     );
      155 |     const execMock = jest
    > 156 |       .spyOn(cp, 'execSync')
          |        ^
      157 |       .mockImplementation((cmd: string) => {
      158 |         if (cmd.includes('git log -1 --pretty=%s')) return Buffer.from('test');
      159 |         return Buffer.from('');

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-check.test.ts:156:8)

  ● memory-check › fails for mismatched summary

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      187 |     );
      188 |     const execMock = jest
    > 189 |       .spyOn(cp, 'execSync')
          |        ^
      190 |       .mockImplementation((cmd: string) => {
      191 |         if (cmd.includes('git log -1 --pretty=%s')) return Buffer.from('correct');
      192 |         return Buffer.from('');

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-check.test.ts:189:8)

  ● memory-check › fails for invalid entry format

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      220 |     );
      221 |     const execMock = jest
    > 222 |       .spyOn(cp, 'execSync')
          |        ^
      223 |       .mockImplementation((cmd: string) => {
      224 |         if (cmd.includes('git log -1 --pretty=%s')) return Buffer.from('something');
      225 |         return Buffer.from('');

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-check.test.ts:222:8)

  ● memory-check › fails when commit hashes repeat

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      257 |     );
      258 |     const execMock = jest
    > 259 |       .spyOn(cp, 'execSync')
          |        ^
      260 |       .mockImplementation((cmd: string) => {
      261 |         if (cmd.includes('git log -1 --pretty=%s')) return Buffer.from('c');
      262 |         return Buffer.from('');

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-check.test.ts:259:8)

  ● memory-check › fails when tasks timestamps decrease

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      295 |     );
      296 |     const execMock = jest
    > 297 |       .spyOn(cp, 'execSync')
          |        ^
      298 |       .mockImplementation((cmd: string) => {
      299 |         if (cmd.includes('git log -1 --pretty=%s')) return Buffer.from('t');
      300 |         return Buffer.from('');

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-check.test.ts:297:8)

  ● memory-check › fails when commit timestamps decrease

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      333 |     );
      334 |     const execMock = jest
    > 335 |       .spyOn(cp, 'execSync')
          |        ^
      336 |       .mockImplementation((cmd: string) => {
      337 |         if (cmd.includes('git log -1 --pretty=%s')) return Buffer.from('m');
      338 |         return Buffer.from('');

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/memory-check.test.ts:335:8)

FAIL src/__tests__/snapshot-rotate.test.ts
  ● snapshot-rotate › truncates context.snapshot.md and creates backup

    expect(received).toBe(expected) // Object.is equality

    - Expected  - 0
    + Received  + 1

      ### 2025-01-01 | mem-002
      b
      ### 2025-01-02 | mem-003
      c

    +

      114 |     const snapOut = fs.readFileSync(tmpSnap, 'utf8');
      115 |     const backupOut = fs.readFileSync(tmpBackup, 'utf8');
    > 116 |     expect(snapOut).toBe(
          |                     ^
      117 |       '### 2025-01-01 | mem-002\n' +
      118 |         'b\n' +
      119 |         '### 2025-01-02 | mem-003\n' +

      at Object.<anonymous> (src/__tests__/snapshot-rotate.test.ts:116:21)

FAIL src/__tests__/economic-events-api.test.ts
  ● economic events api › returns high impact events

    Cannot find module '@/lib/data/economicEvents' from 'src/app/api/economic-events/route.ts'

      1 | import { NextResponse } from 'next/server'
    > 2 | import { fetchHighImpactEvents } from '@/lib/data/economicEvents'
        | ^
      3 | import { CACHE_TTL } from '@/lib/constants'
      4 |
      5 | let cache: { ts: number; data: any } | null = null

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (src/app/api/economic-events/route.ts:2:1)
      at src/__tests__/economic-events-api.test.ts:13:13
      at Object.<anonymous> (src/__tests__/economic-events-api.test.ts:12:10)

FAIL src/__tests__/correlation.test.ts
  ● correlation › zero correlation when arrays differ

    expect(received).toBeCloseTo(expected)

    Expected: 0
    Received: NaN

    Expected precision:    2
    Expected difference: < 0.005
    Received difference:   NaN

       9 |   it('zero correlation when arrays differ', () => {
      10 |     const val = correlation([1, 1, 1], [2, 3, 4]);
    > 11 |     expect(val).toBeCloseTo(0);
         |                 ^
      12 |   });
      13 | });
      14 |

      at Object.<anonymous> (src/__tests__/correlation.test.ts:11:17)

FAIL src/__tests__/mem-list.test.ts
  ● mem-list › prints last n entries

    expect(jest.fn()).toHaveBeenNthCalledWith(n, ...expected)

    n: 1
    Expected: "b"

    Number of calls: 0

      36 |       process.argv = orig
      37 |     })
    > 38 |     expect(log).toHaveBeenNthCalledWith(1, 'b')
         |                 ^
      39 |     expect(log).toHaveBeenNthCalledWith(2, 'c')
      40 |     log.mockRestore()
      41 |     fs.rmSync(dir, { recursive: true, force: true })

      at Object.<anonymous> (src/__tests__/mem-list.test.ts:38:17)

FAIL src/__tests__/mem-sync.test.ts
  ● mem-sync › merges logs from branch

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      13 |     const otherLines = 'a1 | A | y | 2025-01-01T00:00:00Z\n'
      14 |     const exec = jest
    > 15 |       .spyOn(cp, 'execSync')
         |        ^
      16 |       .mockReturnValue(otherLines as any)
      17 |     const read = jest
      18 |       .spyOn(utils, 'readMemoryLines')

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/mem-sync.test.ts:15:8)

FAIL src/__tests__/memory-json.test.ts
  ● memory-json › writes memory.json using atomicWrite with lock

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "/workspace/bitdashfirestudio/memory.json", Any<Function>

    Number of calls: 0

      48 |       ) + '\n';
      49 |
    > 50 |     expect(lockMock).toHaveBeenCalledWith(outPath, expect.any(Function));
         |                      ^
      51 |     expect(atomicMock).toHaveBeenCalledWith(outPath, expected);
      52 |
      53 |     readMock.mockRestore();

      at Object.<anonymous> (src/__tests__/memory-json.test.ts:50:22)

FAIL src/__tests__/precommit.test.ts
  ● pre-commit hook › invokes npm run mem-check

    TypeError: Cannot redefine property: spawnSync
        at Function.defineProperty (<anonymous>)

      16 |   it('invokes npm run mem-check', () => {
      17 |     const spy = jest
    > 18 |       .spyOn(cp, 'spawnSync')
         |        ^
      19 |       .mockReturnValue({ status: 0 } as any);
      20 |     runHook();
      21 |     expect(spy).toHaveBeenCalled();

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/precommit.test.ts:18:8)

FAIL src/__tests__/memgrep.test.ts
  ● memgrep › prints matching lines with ids or hashes

    expect(received).toContain(expected) // indexOf

    Expected value: StringContaining "abc123:"
    Received array: ["abc123: abc123 | fix bug | file | 2025-01-01T00:00:00Z", "mem-001: minor fix details"]

    Looks like you wanted to test for object/array equality with the stricter `toContain` matcher. You probably need to use `toContainEqual` instead.

      53 |
      54 |     const outputs = logMock.mock.calls.map((c) => c[0]);
    > 55 |     expect(outputs).toContain(expect.stringContaining('abc123:'));
         |                     ^
      56 |     expect(outputs).toContain('mem-001: minor fix details');
      57 |     expect(outputs.some((o) => /def456/.test(o))).toBe(false);
      58 |     expect(outputs.some((o) => /mem-002/.test(o))).toBe(false);

      at Object.<anonymous> (src/__tests__/memgrep.test.ts:55:21)

  ● memgrep › prints nothing when no match found

    expect(jest.fn()).not.toHaveBeenCalled()

    Expected number of calls: 0
    Received number of calls: 2

    1: "abc123: abc123 | fix bug | file | 2025-01-01T00:00:00Z"
    2: "mem-001: minor fix details"

      77 |     });
      78 |
    > 79 |     expect(logMock).not.toHaveBeenCalled();
         |                         ^
      80 |
      81 |     logMock.mockRestore();
      82 |     fs.rmSync(dir, { recursive: true, force: true });

      at Object.<anonymous> (src/__tests__/memgrep.test.ts:79:25)

  ● memgrep › respects --since and --until range

    expect(received).toContain(expected) // indexOf

    Expected value: StringContaining "bbb222:"
    Received array: ["abc123: abc123 | fix bug | file | 2025-01-01T00:00:00Z", "mem-001: minor fix details", "bbb222: bbb222 | fix late | file | 2025-01-03T00:00:00Z"]

    Looks like you wanted to test for object/array equality with the stricter `toContain` matcher. You probably need to use `toContainEqual` instead.

      109 |
      110 |     const outputs = logMock.mock.calls.map((c) => c[0]);
    > 111 |     expect(outputs).toContain(expect.stringContaining('bbb222:'));
          |                     ^
      112 |     expect(outputs).toContain('mem-011: late note');
      113 |     expect(outputs.some((o) => /aaa111/.test(o))).toBe(false);
      114 |     expect(outputs.some((o) => /mem-010/.test(o))).toBe(false);

      at Object.<anonymous> (src/__tests__/memgrep.test.ts:111:21)

FAIL src/__tests__/mem-diff.test.ts
  ● mem-diff › prints hashes missing from memory.log

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

       9 |       .mockReturnValue(['abc123 | test | file | 2025-01-01']);
      10 |     const execMock = jest
    > 11 |       .spyOn(cp, 'execSync')
         |        ^
      12 |       .mockReturnValue(Buffer.from('def456\nabc123\n'));
      13 |     const logMock = jest.spyOn(console, 'log').mockImplementation(() => {});
      14 |

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/mem-diff.test.ts:11:8)

  ● mem-diff › prints success message when all hashes present

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      32 |       ]);
      33 |     const execMock = jest
    > 34 |       .spyOn(cp, 'execSync')
         |        ^
      35 |       .mockReturnValue(Buffer.from('def456\nabc123\n'));
      36 |     const logMock = jest.spyOn(console, 'log').mockImplementation(() => {});
      37 |

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/mem-diff.test.ts:34:8)

FAIL src/__tests__/memory-api.test.ts
  ● memory api route › returns parsed memory entries

    Cannot find module '@/lib/constants' from 'src/app/api/memory/route.ts'

       5 |   MemoryEntry,
       6 | } from '../../../../scripts/memory-utils'
    >  7 | import { CACHE_TTL } from '@/lib/constants'
         | ^
       8 |
       9 | let cache: { ts: number; data: MemoryEntry[] } | null = null
      10 | const TTL = parseInt(process.env.MEMORY_API_TTL || String(CACHE_TTL / 1000), 10) * 1000

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (src/app/api/memory/route.ts:7:1)
      at src/__tests__/memory-api.test.ts:18:13
      at Object.<anonymous> (src/__tests__/memory-api.test.ts:17:10)

  ● memory api route › returns empty array when file missing

    Cannot find module '@/lib/constants' from 'src/app/api/memory/route.ts'

       5 |   MemoryEntry,
       6 | } from '../../../../scripts/memory-utils'
    >  7 | import { CACHE_TTL } from '@/lib/constants'
         | ^
       8 |
       9 | let cache: { ts: number; data: MemoryEntry[] } | null = null
      10 | const TTL = parseInt(process.env.MEMORY_API_TTL || String(CACHE_TTL / 1000), 10) * 1000

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (src/app/api/memory/route.ts:7:1)
      at src/__tests__/memory-api.test.ts:33:13
      at Object.<anonymous> (src/__tests__/memory-api.test.ts:32:10)

  ● memory api route › caches results using TTL

    Cannot find module '@/lib/constants' from 'src/app/api/memory/route.ts'

       5 |   MemoryEntry,
       6 | } from '../../../../scripts/memory-utils'
    >  7 | import { CACHE_TTL } from '@/lib/constants'
         | ^
       8 |
       9 | let cache: { ts: number; data: MemoryEntry[] } | null = null
      10 | const TTL = parseInt(process.env.MEMORY_API_TTL || String(CACHE_TTL / 1000), 10) * 1000

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (src/app/api/memory/route.ts:7:1)
      at src/__tests__/memory-api.test.ts:54:13
      at Object.<anonymous> (src/__tests__/memory-api.test.ts:53:10)

FAIL src/__tests__/mem-locate.test.ts
  ● mem-locate › prints block for commit hash

    expect(received).toContain(expected) // indexOf

    Expected substring: "mem-001"
    Received string:    ""

      56 |
      57 |     const out = logMock.mock.calls.map((c) => c[0]).join('\n');
    > 58 |     expect(out).toContain('mem-001');
         |                 ^
      59 |     expect(out).toContain('Commit SHA: abc123');
      60 |
      61 |     logMock.mockRestore();

      at Object.<anonymous> (src/__tests__/mem-locate.test.ts:58:17)

  ● mem-locate › prints block for mem-id

    expect(received).toContain(expected) // indexOf

    Expected substring: "mem-002"
    Received string:    ""

      81 |
      82 |     const out = logMock.mock.calls.map((c) => c[0]).join('\n');
    > 83 |     expect(out).toContain('mem-002');
         |                 ^
      84 |     expect(out).toContain('Commit SHA: def456');
      85 |
      86 |     logMock.mockRestore();

      at Object.<anonymous> (src/__tests__/mem-locate.test.ts:83:17)

FAIL src/__tests__/rebuild-memory.test.ts
  ● rebuild-memory › writes commit history to memory.log

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      18 |
      19 |     const origExec = cp.execSync;
    > 20 |     const execMock = jest.spyOn(cp, 'execSync').mockImplementation((cmd: string, opts?: any) => {
         |                           ^
      21 |       if (cmd.startsWith('ts-node') && cmd.includes('append-memory.ts')) {
      22 |         return Buffer.from('');
      23 |       }

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/rebuild-memory.test.ts:20:27)

  ● rebuild-memory › writes sequential mem-ids to snapshot

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      53 |     let count = 0;
      54 |     const execMock = jest
    > 55 |       .spyOn(cp, 'execSync')
         |        ^
      56 |       .mockImplementation((cmd: string, opts?: any) => {
      57 |         if (cmd.startsWith('ts-node') && cmd.includes('append-memory.ts')) {
      58 |           const sha = origExec('git rev-parse --short HEAD', {

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/rebuild-memory.test.ts:55:8)

FAIL src/__tests__/mem-rotate.test.ts
  ● mem-rotate › truncates memory.log and backs up previous log

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      93 |     fs.writeFileSync(tmpMem, "1\n2\n3\n4\n5\n6\n");
      94 |
    > 95 |     const execMock = jest.spyOn(cp, "execSync").mockReturnValue(Buffer.from(""));
         |                           ^
      96 |
      97 |     const map = {
      98 |       [memPath]: tmpMem,

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/mem-rotate.test.ts:95:27)

  ● mem-rotate › does not modify files during dry run

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      125 |     fs.writeFileSync(tmpMem, "1\n2\n3\n");
      126 |
    > 127 |     const execMock = jest.spyOn(cp, "execSync");
          |                           ^
      128 |
      129 |     const map = {
      130 |       [memPath]: tmpMem,

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/mem-rotate.test.ts:127:27)

FAIL src/__tests__/update-memory.test.ts
  ● update-memory › updates memory log, snapshot and rotates

    TypeError: Cannot redefine property: execSync
        at Function.defineProperty (<anonymous>)

      72 |
      73 |     const calls: string[] = [];
    > 74 |     const execMock = jest.spyOn(cp, 'execSync').mockImplementation((cmd: string) => {
         |                           ^
      75 |       calls.push(cmd);
      76 |       if (cmd.includes('git log -1 --pretty=%s')) return Buffer.from('Task 1: summary');
      77 |       if (cmd.startsWith('grep -m 1')) return Buffer.from('next');

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:776:16)
      at Object.<anonymous> (src/__tests__/update-memory.test.ts:74:27)

FAIL src/__tests__/memory-cli.test.ts (10.587 s)
  ● memory-cli › runs mem-diff for diff command

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      23 |     const diffSpy = jest.spyOn(cli, 'memDiff').mockImplementation(() => {});
      24 |     run(['diff']);
    > 25 |     expect(diffSpy).toHaveBeenCalled();
         |                     ^
      26 |     spy.mockRestore();
      27 |   });
      28 |

      at Object.<anonymous> (src/__tests__/memory-cli.test.ts:25:21)

  ● memory-cli › runs memory-json for json command

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      30 |     const jsonSpy = jest.spyOn(cli, 'memoryJson').mockImplementation(() => {});
      31 |     run(['json']);
    > 32 |     expect(jsonSpy).toHaveBeenCalled();
         |                     ^
      33 |   });
      34 |
      35 |   it('runs clean-locks for clean-locks command', () => {

      at Object.<anonymous> (src/__tests__/memory-cli.test.ts:32:21)

  ● memory-cli › runs clean-locks for clean-locks command

    Property `cleanLocks` does not exist in the provided object

      34 |
      35 |   it('runs clean-locks for clean-locks command', () => {
    > 36 |     const clSpy = jest.spyOn(cli, 'cleanLocks').mockImplementation(() => {});
         |                        ^
      37 |     run(['clean-locks']);
      38 |     expect(clSpy).toHaveBeenCalled();
      39 |   });

      at ModuleMocker.spyOn (node_modules/jest-mock/build/index.js:731:13)
      at Object.<anonymous> (src/__tests__/memory-cli.test.ts:36:24)

  ● memory-cli › runs rebuild-memory for rebuild command

    Command failed: git log --reverse --pretty=format:%h|%s|%cI --name-only
    /bin/sh: 1: /bin/sh: 1: %cI: not found
    %s: not found

      312 |   if (fs.existsSync(memFile)) fs.unlinkSync(memFile);
      313 |   if (fs.existsSync(snapFile)) fs.unlinkSync(snapFile);
    > 314 |   const raw = execSync('git log --reverse --pretty=format:%h|%s|%cI --name-only', { cwd: repo, encoding: 'utf8' });
          |                       ^
      315 |   const lines = raw.trim().split('\n');
      316 |   const entries: { h: string; s: string; d: string; f: string[] }[] = [];
      317 |   let cur: { h: string; s: string; d: string; f: string[] } | undefined;

      at rebuildMemory (scripts/memory-cli.ts:314:23)
      at Object.handler (scripts/memory-cli.ts:393:129)
      at node_modules/yargs/build/index.cjs:1:9095
      at j (node_modules/yargs/build/index.cjs:1:5058)
      at _.handleValidationAndGetResult (node_modules/yargs/build/index.cjs:1:9064)
      at _.applyMiddlewareAndGetResult (node_modules/yargs/build/index.cjs:1:9706)
      at _.runCommand (node_modules/yargs/build/index.cjs:1:7333)
      at te.[runYargsParserAndExecuteCommands] (node_modules/yargs/build/index.cjs:1:58641)
      at te.parse (node_modules/yargs/build/index.cjs:1:40580)
      at Object.main (scripts/memory-cli.ts:399:6)
      at src/__tests__/memory-cli.test.ts:13:9
      at run (src/__tests__/memory-cli.test.ts:12:8)
      at Object.<anonymous> (src/__tests__/memory-cli.test.ts:48:5)

  ● memory-cli › runs update-log for update-log command

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      53 |     const updSpy = jest.spyOn(cli, 'updateLog').mockImplementation(() => {});
      54 |     run(['update-log']);
    > 55 |     expect(updSpy).toHaveBeenCalled();
         |                    ^
      56 |   });
      57 |
      58 |   it('runs update-snapshot for snapshot-update command', () => {

      at Object.<anonymous> (src/__tests__/memory-cli.test.ts:55:20)

  ● memory-cli › runs update-snapshot for snapshot-update command

    Command failed: ts-node scripts/append-memory.ts "feat: Task 114: remove deprecated memory update scripts (#297)" "none"

      357 |   const summary = lastCommitSummary();
      358 |   const nextTask = nextOpenTask();
    > 359 |   execSync(`ts-node scripts/append-memory.ts ${JSON.stringify(summary)} ${JSON.stringify(nextTask)}`, { cwd: repoRoot, stdio: 'inherit', shell: '/bin/bash' });
          |           ^
      360 | }
      361 |
      362 | export function main(argv = hideBin(process.argv)): void {

      at snapshotUpdate (scripts/memory-cli.ts:359:11)
      at Object.handler (scripts/memory-cli.ts:395:91)
      at node_modules/yargs/build/index.cjs:1:9095
      at j (node_modules/yargs/build/index.cjs:1:5058)
      at _.handleValidationAndGetResult (node_modules/yargs/build/index.cjs:1:9064)
      at _.applyMiddlewareAndGetResult (node_modules/yargs/build/index.cjs:1:9706)
      at _.runCommand (node_modules/yargs/build/index.cjs:1:7333)
      at te.[runYargsParserAndExecuteCommands] (node_modules/yargs/build/index.cjs:1:58641)
      at te.parse (node_modules/yargs/build/index.cjs:1:40580)
      at Object.main (scripts/memory-cli.ts:399:6)
      at src/__tests__/memory-cli.test.ts:13:9
      at run (src/__tests__/memory-cli.test.ts:12:8)
      at Object.<anonymous> (src/__tests__/memory-cli.test.ts:60:5)

  ● memory-cli › runs mem-list for list command

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      65 |     const listSpy = jest.spyOn(cli, 'memList').mockImplementation(() => {});
      66 |     run(['list']);
    > 67 |     expect(listSpy).toHaveBeenCalled();
         |                     ^
      68 |   });
      69 | });
      70 |

      at Object.<anonymous> (src/__tests__/memory-cli.test.ts:67:21)

FAIL src/__tests__/file-lock.test.ts (10.853 s)
  ● withFileLock › serializes concurrent writes

    thrown: "Exceeded timeout of 5000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      28 |
      29 | describe('withFileLock', () => {
    > 30 |   it('serializes concurrent writes', async () => {
         |   ^
      31 |     const dir = fs.mkdtempSync(path.join(os.tmpdir(), 'locktest-'));
      32 |     const file = path.join(dir, 'mem.txt');
      33 |     const p1 = run(file, 'A', '100');

      at src/__tests__/file-lock.test.ts:30:3
      at Object.<anonymous> (src/__tests__/file-lock.test.ts:29:1)

  ● withFileLock › handles many concurrent writers

    thrown: "Exceeded timeout of 5000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      87 |   });
      88 |
    > 89 |   it('handles many concurrent writers', async () => {
         |   ^
      90 |     const dir = fs.mkdtempSync(path.join(os.tmpdir(), 'locktest-'));
      91 |     const file = path.join(dir, 'mem.txt');
      92 |     const p1 = run(file, 'A', '200');

      at src/__tests__/file-lock.test.ts:89:3
      at Object.<anonymous> (src/__tests__/file-lock.test.ts:29:1)


Test Suites: 21 failed, 6 passed, 27 total
Tests:       47 failed, 41 passed, 88 total
Snapshots:   0 total
Time:        12.722 s
Ran all test suites.
npm warn Unknown env config "http-proxy". This will stop working in the next major version of npm.

> bitdash-firestudio@1.0.0 backtest
> node --loader ts-node/esm scripts/backtest.ts

(node:6214) ExperimentalWarning: `--experimental-loader` may be removed in the future; instead use `register()`:
--import 'data:text/javascript,import { register } from "node:module"; import { pathToFileURL } from "node:url"; register("ts-node/esm", pathToFileURL("./"));'
(Use `node --trace-warnings ...` to show where the warning was created)
node:internal/modules/esm/loader:309
        throw new ERR_REQUIRE_CYCLE_MODULE(message);
              ^

Error [ERR_REQUIRE_CYCLE_MODULE]: Cannot require() ES Module /workspace/bitdashfirestudio/scripts/backtest.ts in a cycle.
    at ModuleLoader.importSyncForRequire (node:internal/modules/esm/loader:309:15)
    at loadESMFromCJS (node:internal/modules/cjs/loader:1371:24)
    at Module._compile (node:internal/modules/cjs/loader:1511:5)
    at Module._extensions..js (node:internal/modules/cjs/loader:1613:10)
    at Module.load (node:internal/modules/cjs/loader:1275:32)
    at Module._load (node:internal/modules/cjs/loader:1096:12)
    at cjsLoader (node:internal/modules/esm/translators:298:15)
    at ModuleWrap.<anonymous> (node:internal/modules/esm/translators:240:7)
    at ModuleJob.run (node:internal/modules/esm/module_job:263:25)
    at async ModuleLoader.import (node:internal/modules/esm/loader:540:24) {
  code: 'ERR_REQUIRE_CYCLE_MODULE'
}

Node.js v20.19.2
