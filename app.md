# Application Documentation (app.md)

## 1. Overview

This application is designed to automate a series of development tasks, manage a persistent memory system for logging project history and task execution, and ensure data integrity through various checks and structured operations. It heavily relies on Git for version control and as a source for some of its memory logs.

The core functionality revolves around:
*   **Automated Task Execution:** Processing tasks defined in `TASKS.md`, running validation scripts (linting, testing, backtesting), and committing results.
*   **Persistent Memory System:** Maintaining detailed logs of Git commit history (`memory.log`) and application-specific "memory entries" or goals (`context.snapshot.md`).
*   **Data Integrity & Atomicity:** Utilizing atomic file writes and file locking to prevent data corruption during concurrent operations or unexpected shutdowns.

## 2. Key Components & Concepts

### 2.1. Persistent Memory System

The application uses a file-based persistent memory system. Key files and their roles:

*   **`memory.log`**:
    *   **Purpose:** Acts as a chronological log. It primarily stores:
        1.  A history of Git commits relevant to the project, populated by `scripts/update-memory-log.ts`.
        2.  Records of tasks executed by the `autoTaskRunner`, populated by `src/scripts/autoTaskRunner.ts`.
    *   **Format (Dual Format):**
        1.  **Git Commit Entries:** `COMMIT_HASH | GIT_COMMIT_SUMMARY | COMMA_SEPARATED_CHANGED_FILES | GIT_COMMIT_TIMESTAMP`
        2.  **AutoTaskRunner Entries:** `COMMIT_HASH | "Task TASK_NUMBER: TASK_DESCRIPTION" | COMMA_SEPARATED_DIFF_FILES | ISO_TIMESTAMP_OF_TASK_COMPLETION`
    *   **Population:**
        *   `scripts/update-memory-log.ts`: Reads Git history and populates/updates `memory.log` with commit data.
        *   `src/scripts/autoTaskRunner.ts`: Appends an entry after successfully processing and committing a task from `TASKS.md`.
    *   **Rotation:** Managed by `scripts/mem-rotate.ts`, which backs up the old log and trims the live `memory.log` to a configured number of recent entries.
    *   **Location:** Root directory, or path specified by `MEM_PATH` environment variable.

*   **`context.snapshot.md`**:
    *   **Purpose:** Appears to log application-specific "memory entries," goals, or snapshots of context at specific points, associated with a `mem-XXX` ID.
    *   **Format:** Markdown-based, with entries typically starting with `### TIMESTAMP | mem-XXX` followed by details like Commit SHA, Summary, and Next Goal.
    *   **Population:** Primarily by `scripts/append-memory.ts`, which takes a summary and next goal as arguments.
    *   **`mem-XXX` ID Generation:** IDs are generated by `scripts/memory-utils.ts#nextMemId()`, which reads `context.snapshot.md` to determine the last ID. *(Developer Note: A potential race condition exists here if `append-memory.ts` is run concurrently; see `newtasks.md` Task 1 for details on a planned fix).*
    *   **Location:** Root directory, or path specified by `SNAPSHOT_PATH` environment variable.

*   **`signals.json`**:
    *   **Purpose:** Stores state for the `autoTaskRunner`, such as `last_task_completed` (task number) and an `error_flag`.
    *   **Management:** Read and updated by `src/scripts/autoTaskRunner.ts`.
    *   **Location:** Root directory.

*   **Core Utilities (`scripts/memory-utils.ts`)**:
    *   Provides foundational functions for the persistent memory system:
        *   `atomicWrite()`: Ensures file writes are atomic (write to temp then rename).
        *   `withFileLock()`: Provides a file-based locking mechanism to prevent race conditions during file operations.
        *   `readMemoryLines()`: Reads entries from `memory.log`.
        *   `parseMemoryLines()`: Parses the dual-format entries from `memory.log`. *(Developer Note: This needs careful handling due to the two formats; see `newtasks.md` Task 2).*
        *   `validateMemoryEntry()`: Validates parsed `memory.log` entries.
        *   `parseSnapshotEntries()`: Parses entries from `context.snapshot.md`.
        *   `nextMemId()`: Generates the next `mem-XXX` ID.

### 2.2. Automation (`autoTaskRunner`)

*   **Core Script:** `src/scripts/autoTaskRunner.ts` (executed via `scripts/autoTaskRunner.js`).
*   **Workflow:**
    1.  Reads `TASKS.md` to find the next pending task (line starting with `- [ ]`).
    2.  Marks the task as complete (`- [x]`) in `TASKS.md`.
    3.  Updates `signals.json` (e.g., `last_task_completed`).
    4.  Runs validation/build scripts: `npm run lint`, `npm run test`, `npm run backtest`. Logs output to `logs/`.
    5.  If any script fails, sets `error_flag` in `signals.json`, logs a `block-TASKNUM.txt` file, and exits.
    6.  If successful, commits changes to `TASKS.md`, `logs/`, and `signals.json` to Git.
    7.  Appends a new entry to `memory.log` detailing the completed task.
    8.  Commits the `memory.log` update to Git (separate commit).
    9.  Attempts `git pull --rebase origin main` and `git push origin HEAD:main`.
    10. Runs `npm run commitlog` (which executes `scripts/commitlog.ts`).
    11. Loops to the next task.
*   **Task Definition:** Tasks are defined in `TASKS.md`. The runner can infer task numbers or use explicit "Task X:" prefixes.

### 2.3. Validation & Integrity

*   **`scripts/memory-check.ts`**:
    *   Performs extensive validation on `memory.log`:
        *   Uses `validateMemoryEntry()` for basic field checks.
        *   Checks for duplicate commit hashes.
        *   Verifies ascending timestamp order.
        *   Ensures commit hashes exist in Git.
        *   Compares `memory.log` summary with actual Git commit summary.
    *   Cross-references `memory.log` entries with `context.snapshot.md` to find associated `mem-XXX` IDs and checks for their uniqueness and sequence.
    *   *(Developer Note: Enhancements are planned to make this script validate `context.snapshot.md` more directly; see `newtasks.md` Task 5).*
*   **Atomic Operations & Locking:** Used throughout critical file write operations to prevent data corruption.

### 2.4. Logging (`logs/` directory)

*   **`lint.log`, `test.log`, `backtest.log`**: Store the output of the respective npm scripts run by `autoTaskRunner`.
*   **`commit.log`**: Generated by `scripts/commitlog.ts`, contains the raw string of the last 20 entries from `memory.log`. Appears to be for quick diagnostic reference.
*   **`memory-error-TIMESTAMP.txt`**: Created by `scripts/append-memory.ts` if it encounters an error.
*   **`block-TASKNUM.txt`**: Created by `src/scripts/autoTaskRunner.ts` if a task fails during the lint/test/backtest phase.

## 3. Project Structure

*   **`/` (Root):**
    *   `memory.log`: Main memory log.
    *   `context.snapshot.md`: Snapshot/goal log.
    *   `TASKS.md`: Task definitions for the auto-runner.
    *   `signals.json`: State for the auto-runner.
    *   `package.json`, `package-lock.json`: Project dependencies and scripts.
    *   `tsconfig.json`: TypeScript configuration.
    *   `newtasks.md`: Developer tasks for improving this system.
    *   `app.md`: This documentation file.
*   **`scripts/`:** Contains standalone TypeScript utility scripts for memory management, validation, and automation hooks.
    *   `memory-utils.ts`: Core shared utilities.
    *   `append-memory.ts`: Appends to `context.snapshot.md`.
    *   `update-memory-log.ts`: Updates `memory.log` from Git.
    *   `memory-check.ts`: Validates memory files.
    *   `mem-rotate.ts`: Rotates `memory.log`.
    *   `commitlog.ts`: Creates `logs/commit.log`.
    *   `autoTaskRunner.js`: Node.js wrapper to run the TypeScript auto-runner.
*   **`src/scripts/`:** Contains more complex TypeScript logic, currently housing the main `autoTaskRunner.ts`.
*   **`logs/`:** Directory for various log files generated during operation.
*   **Other `src/` directories (e.g., `src/app/`, `src/components/`, `src/lib/`):** Appear to be related to a Next.js application, which may or may not be directly integrated with the memory/automation system described here. This document primarily focuses on the memory and automation aspects found in `scripts/` and `src/scripts/`.

## 4. Setup & Installation

1.  **Prerequisites:**
    *   Node.js (version compatible with project, check `.nvmrc` if present or `package.json` engines).
    *   Git.
2.  **Clone Repository:**
    ```bash
    git clone <repository_url>
    cd <repository_directory>
    ```
3.  **Install Dependencies:**
    ```bash
    npm ci
    ```
    (Using `npm ci` is recommended for consistent dependency installation based on `package-lock.json`).
4.  **Initial Configuration Files:**
    *   Ensure `TASKS.md` exists in the root. If starting fresh, create it with some tasks:
        ```markdown
        - [ ] Initial setup task
        - [ ] Develop feature X
        ```
    *   Ensure `signals.json` exists in the root. If starting fresh, initialize it:
        ```json
        {
          "last_task_completed": -1,
          "error_flag": false
        }
        ```
    *   `memory.log` and `context.snapshot.md` will be created by the scripts if they don't exist.

## 5. Running the Application / Key Scripts

*   **Automated Task Runner:**
    ```bash
    node scripts/autoTaskRunner.js
    ```
    This will start processing tasks from `TASKS.md`.

*   **Update `memory.log` from Git History:**
    ```bash
    ts-node scripts/update-memory-log.ts
    ```
    To also verify after updating:
    ```bash
    ts-node scripts/update-memory-log.ts --verify
    ```

*   **Check Memory Integrity:**
    ```bash
    ts-node scripts/memory-check.ts
    ```

*   **Rotate `memory.log`:**
    ```bash
    ts-node scripts/mem-rotate.ts
    ```
    With a custom limit (e.g., 100 entries):
    ```bash
    ts-node scripts/mem-rotate.ts 100
    ```
    Dry run:
    ```bash
    ts-node scripts/mem-rotate.ts --dry-run
    ```

*   **Append to `context.snapshot.md`:**
    ```bash
    ts-node scripts/append-memory.ts "My snapshot summary" "Next goal details"
    ```

*   **NPM Scripts:**
    Review `package.json` for available npm scripts. Expected scripts used by `autoTaskRunner`:
    *   `npm run lint`
    *   `npm run test`
    *   `npm run backtest`
    *   `npm run commitlog` (likely runs `ts-node scripts/commitlog.ts`)

## 6. Development Workflow

1.  **Define Tasks:** Add new tasks or modify existing ones in `TASKS.md`.
2.  **Implement Changes:** Make code changes related to the task.
3.  **Run Linters/Tests Locally:** Before relying on the auto-runner, run linters and tests for your changes:
    ```bash
    npm run lint
    npm run test
    ```
4.  **Commit Changes (Optional, if not using auto-runner for everything):** If making manual commits, ensure your commit messages are informative.
5.  **Run `autoTaskRunner`:** Let the auto-runner process the task, which will also run tests and manage commits.
6.  **Update Memory System:** If necessary, manually run `scripts/update-memory-log.ts` or other memory utility scripts.
7.  **Verify Integrity:** Periodically run `scripts/memory-check.ts` to ensure the system state is consistent.

**Coding Standards:**
*   The project uses TypeScript. Adhere to TypeScript best practices.
*   Follow existing code style and patterns found in the codebase.
*   Ensure new scripts or modifications are robust and include error handling.

## 7. Key Environment Variables

*   **`MEM_PATH`**: Overrides the default path to `memory.log`.
*   **`SNAPSHOT_PATH`**: Overrides the default path to `context.snapshot.md`.
*   **`MEM_ROTATE_LIMIT`**: Sets the default limit for `memory.log` rotation if not provided as a command-line argument to `scripts/mem-rotate.ts`.

## 8. Known Issues / Areas for Improvement

*   Refer to `newtasks.md` for a detailed list of planned improvements and identified issues. Key items include:
    *   Resolving a race condition in `nextMemId()` generation.
    *   Improving parsing and validation for the dual-format `memory.log`.
    *   Enhancing `memory-check.ts` for more comprehensive validation.

This document provides a starting point for understanding the application's memory and automation systems. For deeper insights, refer to the source code of the respective scripts and the `newtasks.md` file.